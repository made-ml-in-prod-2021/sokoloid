# geo-coord_ml
## общее описание
Программа и утилиты для определения класса территории по GPS координатам и изображению генплана города.
Тип территории определяется способом заливки области на генплане. Заливка может представлять собой как цвет, так и орнамент (штриховка,периодический рисунок, набор точек разных цветов). На заливку могут быть нанесены надписи черно-белым шрифтом и через заливку темным фоном проступают нанесенные на генплан строения)
### Состав пакета 
 структура папок<br>
|<br>
|-data   содержимое папки доступно по ссылке <https://drive.google.com/drive/folders/1JTiAdkXOhMskUArsDiXdR05Xkdit2QKi?usp=sharing> <br>
|   |-interim скан генплана с нанесенными на него комментариями. данные для обучения модели<br>
|   |-queries - файлы запросов к программе<br>
|   |-raw  скан генплана для анализа<br>
|<br>
|-model сохраненные pkl файлы модели<br>
|<br>
|-reports - отчеты (результаты выполнения запросов)<br>
|<br>
|-srс <br>
|   |-model -  исходные файлы программы для анализа, обучения модели, тесты, утилиты<br>
|      |-conf   файлы конфигурации программ (yaml)<br>
|         |- map   компоненты конфигурационных файлов, отвечающие за привязку сканов генпланов конкретных городов (yaml)<br>
|<br>
|-readme.MD   файл readme<br>
|-requirements.txt   файл конфигурации виртуального окружения<br>


### установка в вируальное окружение
скопировать файлы в выделенную папку<br>

выполнить команды:<br>

python -m venv geo-env<br>
geo-env/Scripts/activate<br>
python -m pip install -r requirements.txt<br>


### запуск программы анализа :
из каталога src\model\<br>
выполнить geo-map.py <br>
конфигурация программы  записана в "src\model\conf\config.yaml"<br>
конфигурация карты - "src\model\conf\map\kazan_cfg.yaml"<br>
 
файл запроса данных по умолчанию "data\queries\test_zapros.csv"<br>
выходные данные пишутся в "reports\output.csv"<br>
пример запуска с другими параметрами:<br>
 
geo-map.py  input=data\queries\test_zapros2.csv  output=reports\output2.csv<br>

запуск в режиме отладка: ключ командной строки   debug=True  или debug: True в config.yaml<br>
в этом режиме для кажлого запроса (координат GPS)  будет сохранено мини-изображение участка карты, на котором производится анализ изображения<br>

debug_crop_size:    - 128 размер изображения <br>
debug_image_dir: c:/temp/   файл каталога, в который изображения будут сохранены<br>

полный файл конфигурации<br>
<i>
defaults:<br>
#файл концигурации карты<br>
  - map: kazan_cfg.yaml  <br>

input: data/queries/test_zapros.csv<br>
output: reports/output.csv<br>
debug: False<br>
debug_crop_size: 128<br>
debug_image_dir: c:/temp/<br>
batch_size: 256<br>
threshold: 0.95<br>
#путь к корневому каталогу ПРОГРАММЫ<br>
path_to_root: ../../../../..<br>
  #путь от корневого каталога до изображения карты<br>
  </i>
  
 ### конфигурация скана генплана на примере г.Казань kazan_cfg.yaml  (-src/model/cfg/map/kazan_cfg.yaml)
 <i>
#кординаты GPS 3х точек для привязки карты<br>
#1. Осиновская-Залесская<br>
#2. По центру перекресток Мамадышский тракт  пр-д Хезмэт<br>
#3. Проворот трассы Казань-Боровое-Матюшино в районе Вороновки (пересечение прямых линий  участков тракта)<br>

gps_coord: [[55.85032, 48.89209], [55.80093, 49.31117], [55.63561, 49.10654]]<br>
pixel_coord: [[4070, 8147], [24224, 12310], [14768, 26056]]<br>
crop_size: 32<br>
class_list:<br>
  "0": "Зона исторической застройки"<br>
  "1": "Многофункциональназя зона развития"<br>
  "2": "Зона размещения общественного значения"<br>
  "3": "Специализированная зона размещения объектов торговли, образования, здравоохранения, культуры, спорта"<br>
  "4": "Зона смешанного размещения общественно-деловой и жилой застройки"<br>
  "5": "Зона перспективного формирования жилых районов, освоения территории при условии разработки проекта планировки и Зона многоквартиной многоэтажной жилой застройки с высокой долей общественных функций"<br>
  "6": "Зона индифидуальной и блокированной жилой застройки"<br>
  "7": "Зона смешанной блокированной и малоэтажной многоквартирной жилой застройки"<br>
  "8": "Зона многоквартирной среднеэтажной жилой застройки"<br>
  "9": "Зона многоквартиной многоэтажной жилой застройки"<br>
  "10": "Зона смешенного размещения жилой застройки и производственно-коммунальных объектов"<br>
  "11": "Зона размещения производственных объектов I-V класса опасности и коммунально складского назначения"<br>
  "12": "Зона размещения озеленения специального назначения"<br>
  "13": "Зона размещения объектов внешнего транспорта"<br>
  "14": "Зона размещения объектов специального назначения"<br>
  "15": "Зона размещения твердых бытовых отходов"<br>
  "16": "Зона мест погребения"<br>
  "17": "Зона размещения садоводств"<br>
  "18": "Водные объекты"<br>
</i>

### обучение модели
Для обучение модели служит программа <br>
train.py<br>
параметры запуска программы можно задать через файл train_config.yaml или через командную строку.<br>
файл конфигурации train_config.yaml<br>
<i>
defaults:<br>
  - map: kazan_cfg.yaml<br>
<br>
#путь к корневому каталогу<br>
path_to_root: ..\..\..\..\..<br>
#путь от корневого каталога до изображения карты<br>

walks_file: data\interim\walks4.txt<br>
model_save: best_model_crop32.pkl<br>
train_val_ratio: 0.8<br>
batch_size: 512<br>
crop_size: 32<br>
walk_step: 1<br>
class_cnt: 18<br>
deviation: 3<br>
epoch: 20<br>
lr: 0.001<br>
</i>
данные для обучения  - файл с маршрутом, проложенным по территории одного типа (класса). маршрут представляет собой ломанную, которая задана набором координат точек в пикселях. Не более 10 точек на одном маршруте. <br>
Для обучающей выборки вдоль маршрута выбираются изображения с размером стороны crop_size, шагом walk_step  и случайным отклонением в пределах deviation<br>

### проверка качества обучения и анализ качества разметки - 
программа sort_images.py<br>
файл конфигурации sort_images_config.yaml<br>

программа выполняет расчет количества верно и неверно классифицированных точек изображения. На вход подаются так же как и в train.py маршруты (ломанные). К ним применяются аналогичные преобразования.<br>
Результаты работы сортируются по уровню loss.<br>
Изобажения с наихудшим loss сохраняются в  debug_image_dir<br>
количество неправлильно классифицированных изображений с худшим loss     save_miclassified_images: 10<br>
количество  правлильно классифицированных изображений с худшим loss save_classified_images: 10<br>
<br>
# Самооценка
0) Назовите ветку homework1 (**1 балл**) <br>
0) В описании к пулл реквесту описаны основные "архитектурные" и тактические решения, которые сделаны в вашей работе. В общем, описание что именно вы сделали и для чего, чтобы вашим ревьюерам было легче понять ваш код. (**2 балла**)<br>

1) Выполнение EDA, закоммитьте ноутбук в папку с ноутбуками (**2 баллов**)<br>
Вы так же можете построить в ноутбуке прототип(если это вписывается в ваш стиль работы)<br>
Можете использовать не ноутбук, а скрипт, который сгенерит отчет, закоммитьте и скрипт и отчет (за это + **1 балл**)<br>

2) Проект имеет модульную структуру(не все в одном файле =) ) (**2 баллов**)<br>

3) использованы логгеры (**2 балла**)<br>

4) написаны тесты на отдельные модули и на прогон всего пайплайна(**0/3 баллов**)<br>

5) Для тестов генерируются синтетические данные, приближенные к реальным (**3 баллов**)<br>
- можно посмотреть на библиотеки https://faker.readthedocs.io/en/, https://feature-forge.readthedocs.io/en/latest/<br>
- **можно просто руками посоздавать данных, собственноручно написанными функциями (файл /queries/small_query.csv скачать по ссылке выше)**<br>
как альтернатива, можно закоммитить файл с подмножеством трейна(это не оценивается) <br>

6) Обучение модели конфигурируется с помощью конфигов в json или yaml, закоммитьте как минимум 2 корректные конфигурации, с помощью которых можно обучить модель (разные модели, стратегии split, preprocessing) (**3 балла**)<br>

7) Используются датаклассы для сущностей из конфига, а не голые dict (**3 балла**) <br>

8) Используйте кастомный трансформер(написанный своими руками) и протестируйте его(**3 балла**) Трансформеры (GpsToPixelTransformer,и др)<br>

9) Обучите модель (**train.py**), запишите в readme как это предлагается (**3 балла**)<br>

10) напишите функцию predict (**geo_map.py**), которая примет на вход артефакт/ы от обучения, тестовую выборку(без меток) и запишет предикт, напишите в readme как это сделать (**3 балла**)  <br>

11) Используется hydra  (https://hydra.cc/docs/intro/) (**3 балла - доп баллы**)<br>

12) Настроен CI(прогон тестов, линтера) на основе github actions  (**0/3 балла** - доп баллы <br>
13) Проведите самооценку, опишите, в какое колво баллов по вашему мнению стоит оценить вашу работу и почему (**1 балл доп баллы**)<br> 

Итог<br>
1<br>
2<br>
2<br>
1<br>
2<br>
2<br>
0<br>
3 <br>
3<br>
3<br>
3<br>
3<br>
3<br>
3<br>
0<br>
1<br>

<b> Итог 32 балла </b>

